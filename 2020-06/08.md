# 学习 浏览器工作原理与实践

## 32 | 同源策略：为什么 XMLHttpRequest 不能跨域请求资源？

### 什么是同源策略

如果两个 URL 的协议、域名和端口都相同，我们就称这两个 URL 同源。

浏览器默认两个相同的源之间是可以相互访问资源和操作 DOM 的。两个不同的源之间想要相互访问资源或者操作 DOM，有一套基础的安全策略的制约，就称为同源策略。

同源策略主要表现在 DOM、Web 数据和网络这三个层面：

### 安全和便利性的权衡

1. 页面中可以引用第三方资源，暴露了很多诸如 XSS 的安全问题，在这种开放的基础之上引入了 CSP 来限制其自由程度。
   XSS 攻击指的是通过利用网页开发时留下的漏洞，通过巧妙的方法注入恶意指令代码到网页，使用户加载并执行攻击者恶意制造的网页程序。
   CSP 的核心思想是让服务器决定浏览器能够加载哪些资源，让服务器决定浏览器是否能够执行内联 JavaScript 代码。
2. 使用 XMLHttpRequest 和 Fetch 都是无法直接进行跨域请求的，因此浏览器又在这种严格策略的基础之上引入了跨域资源共享策略，让其可以安全地进行跨域操作。
3. 两个不同源的 DOM 是不能相互操纵的，浏览器中又实现了跨文档消息机制，让其可以比较安全地通信。

## 33 | 跨站脚本攻击（XSS）：为什么 Cookie 中有 HttpOnly 属性？

### 什么是 XSS 攻击

XSS 全称是 Cross Site Scripting，为了与“CSS”区分开来，简称 XSS，翻译“跨站脚本”

#### XSS 主要做什么

1. 窃取 Cookie 信息
2. 监听用户行为
3. 修改 DOM
4. 在页面内生成浮窗广告

### 恶意脚本是怎么注入的

主要有存储型 XSS 攻击、反射型 XSS 攻击和基于 DOM 的 XSS 攻击三种方式来注入恶意脚本。

1. 存储型 XSS 攻击

   - 首先黑客利用站点漏洞将一段恶意 JavaScript 代码提交到网站的数据库中；
   - 然后用户向网站请求包含了恶意 JavaScript 脚本的页面；
   - 当用户浏览该页面的时候，恶意脚本就会将用户的 Cookie 信息等数据上传到服务器。
     ![avatar](../image/ccgj.png)

2. 反射型 XSS 攻击
   反射型 XSS 攻击，恶意 JavaScript 脚本属于用户发送给网站请求中的一部分，随后网站又把恶意 JavaScript 脚本返回给用户。当恶意 JavaScript 脚本在用户页面中被执行时，黑客就可以利用该脚本做一些恶意操作。

3. 基于 DOM 的 XSS 攻击
   将恶意脚本注入用户的页面中，比如通过网络劫持在页面传输过程中修改 HTML 页面的内容，劫持类型很多，有通过 WiFi 路由器劫持的，有通过本地恶意软件来劫持的，共同点是在 Web 资源传输过程或者在用户使用页面的过程中修改 Web 页面的数据。

### 如何阻止 XSS 攻击

1. 服务器对输入脚本进行过滤或转码
2. 充分利用 CSP
   CSP 功能：
   - 限制加载其他域下的资源文件，即使黑客插入了一个 JavaScript 文件，这个 JavaScript 文件也是无法被加载的；
   - 禁止向第三方域提交数据，这样用户数据也不会外泄；
   - 禁止执行内联脚本和未授权的脚本；
   - 提供了上报机制，这样可以帮助我们尽快发现有哪些 XSS 攻击，以便尽快修复问题。
3. 使用 HttpOnly 属性
   使用 HttpOnly 标记的 Cookie 只能使用在 HTTP 请求过程中，无法通过 JavaScript 来读取这段 Cookie。
