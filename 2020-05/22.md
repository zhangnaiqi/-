# 学习 浏览器工作原理与实践

## 14 | 编译器和解释器：V8 是如何执行一段 JavaScript 代码的？

### 编译器和解释器

我们所写的代码“翻译”成机器能读懂的机器语言。按语言的执行流程，可以把语言划分为编译型语言和解释型语言。

![avatar](../image/bianyi.png)

### V8 是如何执行一段 JavaScript 代码的

V8 在执行过程中既有解释器 Ignition，又有编译器 TurboFan

V8 执行一段代码流程图:

![avatar](../image/V8liucheng.png)

#### 1. 生成抽象语法树（AST）和执行上下文

生成 AST,第一阶段分词（tokenize），又称为词法分析，将一行行的源码拆解成一个个 token；第二阶段是解析（parse），又称为语法分析，将生成的 token 数据，根据语法规则转为 AST。

#### 2. 生成字节码

字节码是介于 AST 和机器码之间的一种代码。，字节码需要通过解释器将其转换为机器码后才能执行。

解释器（Ignition）根据 AST 生成字节码，并解释执行字节码。

#### 3. 执行代码

解释器 （Ignition） 逐条解释执行字节码

### JavaScript 的性能优化

1. 提升单次脚本的执行速度，避免 JavaScript 的长任务霸占主线程，这样可以使得页面快速响应交互；
2. 避免大的内联脚本，因为在解析 HTML 的过程中，解析和编译也会占用主线程；
3. 减少 JavaScript 文件的容量，因为更小的文件会提升下载速度，并且占用更低的内存。

## 15 | 消息队列和事件循环：页面是怎么“活”起来的？

页面使用单线程的缺点：第一个问题是如何处理高优先级的任务；第二个是如何解决单个任务执行时长过久的问题；

如果有一些确定好的任务，可以使用一个单线程来按照顺序处理这些任务，这是第一版线程模型。

![avatar](../image/1xiancheng.png)

要在线程执行过程中接收并处理新的任务，就需要引入循环语句和事件系统，这是第二版线程模型。

![avatar](../image/2xiancheng.png)

如果要接收其他线程发送过来的任务，就需要引入消息队列，这是第三版线程模型。

![avatar](../image/3xiancheng.png)

如果其他进程想要发送任务给页面主线程，那么先通过 IPC 把任务发送给渲染进程的 IO 线程，IO 线程再把任务发送给页面主线程。

![avatar](../image/kuajincheng.png)
