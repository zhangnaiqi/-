# 学习 浏览器工作原理与实践

## 23 | 渲染流水线：CSS 如何影响首次加载时的白屏时间？

### 影响页面展示的因素以及优化策略

#### 影响页面展示的因素

1. 第一个阶段，等请求发出去之后，到提交数据阶段，这时页面展示出来的还是之前页面的内容。
2. 第二个阶段，提交数据之后渲染进程会创建一个空白页面，我们通常把这段时间称为解析白屏，并等待 CSS 文件和 JavaScript 文件的加载完成，生成 CSSOM 和 DOM，然后合成布局树，最后还要经过一系列的步骤准备首次渲染。（主要问题是白屏时间）
3. 第三个阶段，等首次渲染完成之后，就开始进入完整页面的生成阶段了，然后页面会一点点被绘制出来。

缩短白屏时长，优化策略：

1. 内联 JavaScript、内联 CSS 来移除这两种类型的文件下载，这样获取到 HTML 文件之后就可以直接开始渲染流程了。
2. 不是所有的场合都适合内联，还可以尽量减少文件大小，通过 webpack 等工具移除一些不必要的注释，压缩 JavaScript 文件。
3. 大的 CSS 文件，通过媒体查询属性，拆分为多个不同用途的 CSS 文件，在特定的场景下才会加载特定的 CSS 文件。(按需加载)

## 24 | 分层和合成机制：为什么 CSS 动画比 JavaScript 高效？

### 显示器是怎么显示图像的

显示器都有固定的刷新频率，例如 60HZ，也就是每秒更新 60 张图片，更新的图片都来自于显卡中前缓冲区，显示器所做的任务就是每秒固定读取 60 次前缓冲区中的图像，并将读取的图像显示到显示器上。

#### 显卡做什么

合成新的图像，并将图像保存到后缓冲区，显卡把合成的图像写到后缓冲区，系统就会让后缓冲区和前缓冲区互换，这样就能保证显示器能读取到最新显卡合成的图像。

### 帧 VS 帧率

每一副图片称为一帧，把渲染流水线每秒更新了多少帧称为帧率。

### 如何生成一帧图像

重排、重绘和合成三种方式（这里只介绍了有哪些方法）

Chrome 中的合成技术：分层、分块和合成。

#### 分层和合成

将素材分解为多个图层的操作就称为分层，最后将图层合并到一起的操作就称为合成。

## 25 | 页面性能：如何系统地优化页面？

页面有三个阶段：加载阶段、交互阶段和关闭阶段。

1. 加载阶段，是指从发出请求到渲染出完整页面的过程，影响到这个阶段的主要因素有网络和 JavaScript 脚本。
2. 交互阶段，主要是从页面加载完成到用户交互的整合过程，影响到这个阶段的主要因素是 JavaScript 脚本。
3. 关闭阶段，主要是用户发出关闭指令后页面所做的一些清理操作。

### 如何优化

1. 减少 JavaScript 脚本执行时间

   一次执行的函数分解为多个任务，使得每次的执行时间不要过久；采用 Web Workers（这个没用过），Web Workers 是主线程之外的一个线程，没有 DOM、CSSOM 环境，无法通过 JavaScript 来访问 DOM 。

2. 避免强制同步布局

   强制同步：JavaScript 强制将计算样式和布局操作提前到当前的任务中；

3. 避免布局抖动

   布局抖动是指在一次 JavaScript 执行过程中，多次执行强制布局和抖动操作。

4. 合理利用 CSS 合成动画

5. 避免频繁的垃圾回收

   JavaScript 使用自动垃圾回收机制,函数中频繁创建临时对象，垃圾回收器会频繁地去执行垃圾回收策略。当垃圾回收操作发生时，就会占用主线程，影响到其他任务的执行，严重的话还会让用户产生掉帧、不流畅的感觉。优化储存结构，尽可能避免小颗粒对象的产生。
